<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>IPTV VR - Modo Cine</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    :root{--bg:#0f1720;--accent:#00d4ff;--danger:#ff4444}
    *{box-sizing:border-box;font-family:sans-serif}
    html,body{height:100%;margin:0;background:#051019;color:#e6eef6;overflow:hidden}
    .container{max-width:900px;margin:18px auto;padding:18px;position:relative;z-index:2}
    h1{text-align:center;color:var(--accent);font-size:22px}
    .input-section{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    input{flex:1;padding:12px;border-radius:8px;border:1px solid #22303a;background:#0b1115;color:#fff}
    button{background:var(--accent);border:none;padding:12px;border-radius:8px;font-weight:bold;cursor:pointer}
    .btn-vr{background:#ff00ff;color:#fff;box-shadow:0 0 10px #ff00ff}
    .channel-list{background:#071018;border-radius:10px;padding:8px;max-height:200px;overflow:auto;border:1px solid #16202a;margin-bottom:10px}
    .channel-item{padding:10px;border-bottom:1px solid #16202a;cursor:pointer;display:flex;justify-content:space-between}
    
    /* CAPA VR */
    #vr-layer{display:none;position:fixed;inset:0;z-index:10;background:#000}
    body.is-vr #vr-layer{display:block}
    body.is-vr .container{display:none}
    #btn-exit-vr {
      display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%);
      z-index:1000; background:var(--danger); color:#fff; padding:10px 20px; border-radius:20px; border:none;
    }
    body.is-vr #btn-exit-vr{display:block}
    
    .player-shell{width:100%;height:400px;background:#000;border-radius:10px;overflow:hidden}
    video, iframe{width:100%;height:100%;border:0}
  </style>
  <script type="importmap">{ "imports": { "hls.js": "https://esm.sh/hls.js@1.4.12" } }</script>
</head>
<body>

  <button id="btn-exit-vr" onclick="toggleVR()">SALIR MODO CINE</button>

  <div id="vr-layer">
    <a-scene embedded loading-screen="enabled: false" vr-mode-ui="enabled: false">
      <a-entity camera look-controls position="0 1.6 0"></a-entity>
      
      <a-video src="#videoPlayer" width="8" height="4.5" position="0 1.6 -5"></a-video>
      
      <a-sky color="#000"></a-sky>
    </a-scene>
  </div>

  <div class="container">
    <h1>IPTV VR - Modo Cine</h1>
    <div class="input-section">
      <input id="channelUrl" type="text" placeholder="URL .m3u8 o mp4..." />
      <button id="loadBtn">Cargar</button>
      <button onclick="toggleVR()" class="btn-vr">ENTRAR VR</button>
    </div>
    <div class="input-section">
      <input id="m3uFile" type="file" accept=".m3u" />
      <button id="listBtn">Cargar M3U</button>
    </div>
    <div id="channelList" class="channel-list"></div>
    <div class="player-shell">
      <video id="videoPlayer" controls playsinline webkit-playsinline></video>
    </div>
  </div>

  <script type="module">
    import Hls from "hls.js";

    const state = { channels: [], current: -1 };
    const video = document.getElementById('videoPlayer');
    let hls = null;

    window.toggleVR = () => {
      const isVr = document.body.classList.toggle('is-vr');
      if (isVr) document.documentElement.requestFullscreen().catch(()=>{});
      else if (document.fullscreenElement) document.exitFullscreen();
    };

    function playIndex(i) {
      if (i < 0 || i >= state.channels.length) return;
      state.current = i;
      const url = state.channels[i].url;
      if (hls) hls.destroy();
      if (url.includes('.m3u8')) {
        hls = new Hls(); hls.loadSource(url); hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else { video.src = url; video.play(); }
    }

    // CARGAR URL MANUAL
    document.getElementById('loadBtn').onclick = () => {
      const url = document.getElementById('channelUrl').value;
      if(url){ state.channels.push({title:"Manual", url}); playIndex(state.channels.length-1); render(); }
    };

    // CARGAR M3U
    document.getElementById('listBtn').onclick = async () => {
      const file = document.getElementById('m3uFile').files[0];
      if(!file) return;
      const text = await file.text();
      const lines = text.split('\n');
      lines.forEach((l, i) => {
        if(l.startsWith('#EXTINF')) state.channels.push({title: l.split(',')[1] || "Canal", url: lines[i+1].trim()});
      });
      render();
    };

    function render() {
      const list = document.getElementById('channelList');
      list.innerHTML = state.channels.map((c, i) => `<div class="channel-item" onclick="playIndex(${i})">${c.title}</div>`).join('');
    }

    // ==========================================
    // CONTROL TOTAL CON EL MANDO (MODO MOUSE)
    // ==========================================
    window.addEventListener('mousedown', (e) => {
      if (!document.body.classList.contains('is-vr')) return;

      // Detectamos si es clic izquierdo o derecho del control
      if (e.button === 0) { // Clic principal (Gatillo o A)
        playIndex((state.current + 1) % state.channels.length);
      } else if (e.button === 2) { // Clic derecho o botón atrás
        playIndex((state.current - 1 + state.channels.length) % state.channels.length);
      }
    });

    // Prevenir menú contextual al usar clic derecho del control
    window.oncontextmenu = (e) => { if(document.body.classList.contains('is-vr')) e.preventDefault(); };
  </script>
</body>
</html>