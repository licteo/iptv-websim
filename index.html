<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>IPTV VR Permanente</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <style>
    :root{--bg:#051019;--accent:#00d4ff;--danger:#ff4444;--success:#39ff14}
    *{box-sizing:border-box;font-family:sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;overflow:hidden}
    
    .container{max-width:980px;margin:12px auto;padding:15px;transition:opacity 0.3s}
    body.is-vr .container { opacity:0; pointer-events:none; position:absolute; z-index:-1 }
    
    .input-section{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
    input{flex:1;padding:12px;border-radius:8px;border:1px solid #22303a;background:#0b1115;color:#fff;font-size:16px}
    button{border:none;padding:12px;border-radius:8px;font-weight:bold;cursor:pointer}
    
    .btn-load{background:var(--accent); color:#000}
    .btn-fs{background:var(--success); color:#000}
    .btn-vr{background:#ff00ff; color:#fff}
    .btn-clear{background:#444; color:#fff; font-size:11px; padding:5px 10px}

    .channel-list{background:#071018;border-radius:10px;padding:5px;max-height:160px;overflow:auto;border:1px solid #16202a;margin-bottom:10px}
    .channel-item{padding:12px;border-bottom:1px solid #16202a;cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    .channel-item:hover{background:#111b25}
    .channel-item.active{border-left:4px solid var(--accent); background:#111b25}

    #vr-layer { display:none; position:fixed; inset:0; z-index:9999; background:#000 }
    body.is-vr #vr-layer { display:block }
    #btn-exit-vr { position:fixed; top:15px; right:15px; z-index:10000; background:var(--danger); color:white; padding:10px 20px; border-radius:20px; font-weight:bold; border:2px solid white }

    #center-guide { position:fixed; top:0; bottom:0; left:50%; width:2px; background:rgba(255,255,255,0.3); transform:translateX(-50%); z-index:9998; pointer-events:none }

    #feedback{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); color:#fff; padding:15px 25px; border-radius:30px; display:none; z-index:10005; pointer-events:none; border:1px solid var(--accent); font-weight:bold }

    .video-container{background:#000; border-radius:12px; position:relative; overflow:hidden; width:100%; height:320px; border:1px solid #22303a}
    #fullPlayerArea { width:100%; height:100%; position:relative; background:#000; display:flex; align-items:center }
    
    #videoPlayer, #webFrame { width:100%; height:100%; border:none; display:none }
    video { object-fit:contain }

    @media (max-width:640px){ .video-container{height:230px} }
  </style>

  <script type="importmap">{ "imports": { "hls.js": "https://esm.sh/hls.js@1.4.12" } }</script>
</head>
<body>

  <div id="vr-layer">
    <button id="btn-exit-vr" onclick="window.toggleVR()">SALIR</button>
    <div id="center-guide"></div>
    
    <a-scene embedded loading-screen="enabled:false" vr-mode-ui="enabled:false">
      <a-entity camera look-controls position="0 1.6 0"></a-entity>
      <a-entity id="vr-container" position="0 1.6 -3.5">
          <a-video id="screenLeft" src="#videoPlayer" width="4.8" height="2.7" material="shader:flat"></a-video>
          <a-video id="screenRight" src="#videoPlayer" width="4.8" height="2.7" material="shader:flat"></a-video>
          <a-plane position="0 0 0.1" width="0.2" height="5" color="#000" material="shader:flat"></a-plane>
      </a-entity>
      <a-sky color="#000"></a-sky>
    </a-scene>
  </div>

  <div class="container">
    <h1 style="text-align:center; color:var(--accent); margin:0 0 10px 0; font-size:22px">IPTV VR Premium</h1>
    
    <div class="input-section">
      <input id="urlIn" type="text" placeholder="URL Canal (.m3u8, .mp4, Web)" />
      <button onclick="window.addUrl()" class="btn-load">AÑADIR</button>
    </div>

    <div style="display:flex; justify-content:space-between; margin-bottom:8px">
        <button onclick="window.toggleFS()" class="btn-fs">FULL SCREEN</button>
        <button onclick="window.toggleVR()" class="btn-vr">MODO VR</button>
        <button onclick="window.clearAll()" class="btn-clear">Limpiar</button>
    </div>

    <div class="channel-list" id="list"></div>

    <div class="video-container">
      <div id="fullPlayerArea">
        <div id="feedback"></div>
        <video id="videoPlayer" crossorigin="anonymous" playsinline webkit-playsinline controls></video>
        <iframe id="webFrame" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import Hls from "hls.js";

    // CLAVE DE MEMORIA: iptv_v3
    const CONFIG_KEY = 'iptv_config_v3';
    let config = JSON.parse(localStorage.getItem(CONFIG_KEY)) || { 
        channels: [], 
        lastIndex: -1, 
        eyeGap: 2.15 
    };
    
    const video = document.getElementById('videoPlayer');
    const iframe = document.getElementById('webFrame');
    const feedback = document.getElementById('feedback');
    let hls = null;

    // APLICAR CONFIGURACIÓN GUARDADA AL INICIO
    function applyConfig() {
        const left = document.getElementById('screenLeft');
        const right = document.getElementById('screenRight');
        if(left && right) {
            left.setAttribute('position', `-${config.eyeGap} 0 0`);
            right.setAttribute('position', `${config.eyeGap} 0 0`);
        }
        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
    }

    window.saveChannels = () => {
        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
    };

    window.adjustEyes = (delta) => {
        config.eyeGap = Math.max(1.0, Math.min(3.5, config.eyeGap + delta));
        applyConfig();
        showFeedback(`Ajuste: ${config.eyeGap.toFixed(2)}`);
    };

    window.playUrl = async (url, index) => {
      config.lastIndex = index;
      window.saveChannels();
      render();

      if(hls) { hls.destroy(); hls = null; }
      
      const isM3U8 = url.toLowerCase().includes('.m3u8');
      const isVideo = url.match(/\.(mp4|webm|avi|mov)$/i);

      if (isM3U8 || isVideo) {
        iframe.style.display = "none"; iframe.src = "";
        video.style.display = "block";
        if (Hls.isSupported() && isM3U8) {
          hls = new Hls(); hls.loadSource(url); hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
        } else { 
          video.src = url; video.load(); video.play().catch(()=>{}); 
        }
      } else {
        video.style.display = "none"; video.pause();
        iframe.style.display = "block"; iframe.src = url;
      }
    };

    window.addUrl = () => {
      const input = document.getElementById('urlIn');
      if(input.value.trim()){
        config.channels.push({title: "Canal " + (config.channels.length + 1), url: input.value.trim()});
        input.value = "";
        window.saveChannels();
        render();
        window.playUrl(config.channels[config.channels.length-1].url, config.channels.length-1);
      }
    };

    window.playNext = () => {
      if(config.channels.length === 0) return;
      let next = (config.lastIndex + 1) % config.channels.length;
      showFeedback("SIGUIENTE");
      window.playUrl(config.channels[next].url, next);
    };

    window.toggleVR = () => {
      document.body.classList.toggle('is-vr');
      if(document.body.classList.contains('is-vr')) {
          document.documentElement.requestFullscreen?.().catch(()=>{});
          setTimeout(applyConfig, 100);
      }
    };

    window.toggleFS = () => {
      const area = document.getElementById('fullPlayerArea');
      if (!document.fullscreenElement) area.requestFullscreen?.();
      else document.exitFullscreen?.();
    };

    window.clearAll = () => {
      if(confirm("¿Borrar todo?")) {
        config.channels = []; config.lastIndex = -1;
        window.saveChannels(); render();
        video.src = ""; iframe.src = "";
      }
    };

    function showFeedback(txt) {
      feedback.textContent = txt; feedback.style.display = "block";
      setTimeout(() => feedback.style.display = "none", 1000);
    }

    function render() {
      const listDiv = document.getElementById('list');
      if(config.channels.length === 0) {
        listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#444">Sin canales</div>';
        return;
      }
      listDiv.innerHTML = config.channels.map((ch, i) => 
        `<div class="channel-item ${config.lastIndex === i ? 'active' : ''}" onclick="window.playUrl('${ch.url}', ${i})">
            <span>${ch.title}</span><span style="color:var(--accent)">PLAY</span>
         </div>`
      ).join('');
    }

    // Inicialización
    render();
    applyConfig();
    if(config.lastIndex >= 0) window.playUrl(config.channels[config.lastIndex].url, config.lastIndex);

    // Controles de mando y táctil
    window.addEventListener('keydown', (e) => {
        if(!document.body.classList.contains('is-vr')) return;
        if(e.code === 'ArrowUp' || e.code === 'KeyW') window.adjustEyes(0.05);
        if(e.code === 'ArrowDown' || e.code === 'KeyS') window.adjustEyes(-0.05);
        if(e.code === 'Enter' || e.code === 'Space') window.playNext();
    });

    window.addEventListener('touchstart', (e) => {
        if(!document.body.classList.contains('is-vr') || e.target.id === 'btn-exit-vr') return;
        const y = e.touches[0].clientY / window.innerHeight;
        if(y < 0.25) window.adjustEyes(0.1);
        else if(y > 0.75) window.adjustEyes(-0.1);
        else window.playNext();
    });
  </script>
</body>
</html>