<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>IPTV VR Fix - Controles Sincronizados</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    :root{--accent:#00d4ff;--danger:#ff4444}
    *{box-sizing:border-box;font-family:sans-serif}
    body, html{margin:0;padding:0;width:100%;height:100%;background:#000;color:#fff;overflow:hidden}
    .container{padding:20px;max-width:600px;margin:0 auto}
    input, button{width:100%;padding:12px;margin:5px 0;border-radius:8px;border:none}
    button{background:var(--accent);font-weight:bold;cursor:pointer}
    .btn-vr{background:#ff00ff;color:#fff}
    #btn-exit-vr{display:none;position:fixed;top:10px;left:10px;z-index:9999;background:var(--danger);width:auto}
    body.is-vr #btn-exit-vr{display:block}
    body.is-vr .container{display:none}
    #vr-layer{display:none;position:fixed;inset:0}
    body.is-vr #vr-layer{display:block}
    .linea-guia{position:fixed;left:50%;top:0;bottom:0;width:2px;background:rgba(255,255,255,0.2);z-index:100;pointer-events:none;display:none}
    body.is-vr .linea-guia{display:block}
    video{display:none}
  </style>
</head>
<body>

  <button id="btn-exit-vr" onclick="toggleVR()">CERRAR VR</button>
  <div class="linea-guia"></div>

  <div id="vr-layer">
    <a-scene embedded vr-mode-ui="enabled: false" cursor="rayOrigin: mouse">
      <a-assets>
        <video id="videoPlayer" playsinline webkit-playsinline crossorigin="anonymous"></video>
      </a-assets>

      <a-entity camera look-controls position="0 1.6 0">
        <a-entity cursor="fuse: false; raycaster: .clickable" 
                  position="0 0 -1" 
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015" 
                  material="color: white; shader: flat">
        </a-entity>
      </a-entity>

      <a-video src="#videoPlayer" width="4" height="2.25" position="-2.1 1.6 -3"></a-video>
      <a-video src="#videoPlayer" width="4" height="2.25" position="2.1 1.6 -3"></a-video>

      <a-entity id="menu-vr" position="0 0.5 -2.8">
        <a-circle id="vr-prev" class="clickable" position="-0.6 0 0" radius="0.2" color="#00d4ff">
          <a-text value="ANT" align="center" position="0 0 0.01" width="3"></a-text>
        </a-circle>
        
        <a-circle id="vr-next" class="clickable" position="0.6 0 0" radius="0.2" color="#00d4ff">
          <a-text value="SIG" align="center" position="0 0 0.01" width="3"></a-text>
        </a-circle>
      </a-entity>

      <a-sky color="#000"></a-sky>
    </a-scene>
  </div>

  <div class="container">
    <h2>IPTV VR Player</h2>
    <input id="m3uUrl" type="text" placeholder="Pega URL de lista M3U aquÃ­">
    <button onclick="cargarDesdeUrl()">Cargar Lista</button>
    <input id="m3uFile" type="file" accept=".m3u">
    <button onclick="cargarDesdeArchivo()" style="background:#444;color:#fff">Subir Archivo M3U</button>
    <hr>
    <button onclick="toggleVR()" class="btn-vr">ENTRAR MODO VR</button>
    <div id="lista" style="margin-top:20px; max-height:200px; overflow-y:auto"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('videoPlayer');
    const state = { channels: [], index: 0 };
    let hls = new Hls();

    function toggleVR() {
      document.body.classList.toggle('is-vr');
      if (document.body.classList.contains('is-vr')) {
        document.documentElement.requestFullscreen().catch(() => {});
      } else {
        if(document.fullscreenElement) document.exitFullscreen();
      }
    }

    function playChannel(url) {
      if (Hls.isSupported()) {
        hls.destroy();
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else {
        video.src = url;
        video.play();
      }
    }

    function change(dir) {
      if (state.channels.length === 0) return;
      state.index = (state.index + dir + state.channels.length) % state.channels.length;
      playChannel(state.channels[state.index].url);
      console.log("Cambiado a:", state.channels[state.index].name);
    }

    // Eventos para VR (Hacen clic en el objeto 3D)
    document.getElementById('vr-prev').addEventListener('click', (e) => { e.stopPropagation(); change(-1); });
    document.getElementById('vr-next').addEventListener('click', (e) => { e.stopPropagation(); change(1); });

    // Carga de canales
    function procesarM3U(text) {
      const lines = text.split('\n');
      state.channels = [];
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].includes('#EXTINF')) {
          const name = lines[i].split(',')[1] || "Canal sin nombre";
          const url = lines[i+1]?.trim();
          if (url && url.startsWith('http')) {
            state.channels.push({ name, url });
          }
        }
      }
      if (state.channels.length > 0) {
        state.index = 0;
        playChannel(state.channels[0].url);
        renderLista();
      }
    }

    async function cargarDesdeUrl() {
      const url = document.getElementById('m3uUrl').value;
      if (!url) return;
      try {
        const res = await fetch(url);
        const text = await res.text();
        procesarM3U(text);
      } catch (e) { alert("Error cargando URL. Verifica CORS."); }
    }

    function cargarDesdeArchivo() {
      const file = document.getElementById('m3uFile').files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => procesarM3U(e.target.result);
      reader.readAsText(file);
    }

    function renderLista() {
      const div = document.getElementById('lista');
      div.innerHTML = state.channels.map((c, i) => 
        `<div onclick="state.index=${i}; playChannel('${c.url}')" style="padding:10px; border-bottom:1px solid #333; cursor:pointer">${c.name}</div>`
      ).join('');
    }
  </script>
</body>
</html>