<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#00d4ff" />
  <title>Reproductor IPTV VR Final</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <style>
    :root{--bg:#0f1720;--accent:#00d4ff;--danger:#ff4444}
    *{box-sizing:border-box;font-family:sans-serif}
    body,html{height:100%;margin:0;background:#051019;color:#fff;overflow:hidden}
    
    /* UI 2D (Fuera de VR) */
    .container{max-width:800px;margin:20px auto;padding:15px; position:absolute; inset:0; overflow-y:auto; z-index:2}
    .input-group{display:flex;gap:10px;margin-bottom:10px}
    input{flex:1;padding:10px;background:#141922;border:1px solid #333;color:#fff;border-radius:5px}
    button{padding:10px 15px;background:var(--accent);border:none;border-radius:5px;font-weight:bold;cursor:pointer;color:#000}
    .btn-vr{background:#ff00ff;color:#fff}
    .channel-list{background:#111;border-radius:5px;max-height:200px;overflow-y:auto}
    .item{padding:10px;border-bottom:1px solid #222;cursor:pointer}
    .item:hover{background:#222}

    /* CAPA VR */
    #vr-layer{display:none;position:fixed;inset:0;z-index:1}
    body.is-vr #vr-layer{display:block}
    body.is-vr .container{display:none}

    /* Botón Salir VR Flotante */
    #btn-exit-vr {
      display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%);
      z-index:9999; background:red; color:white; padding:10px 20px; border-radius:30px; border:2px solid white;
    }
    body.is-vr #btn-exit-vr{display:block}
    
    video { display: none; } /* El video se renderiza en el canvas, ocultamos el elemento DOM */
  </style>

  <script type="importmap">{ "imports": { "hls.js": "https://esm.sh/hls.js@1.4.12" } }</script>
</head>
<body>

  <video id="videoPlayer" playsinline webkit-playsinline crossorigin="anonymous"></video>

  <button id="btn-exit-vr" onclick="toggleVR()">SALIR VR</button>

  <div id="vr-layer">
    <a-scene embedded loading-screen="enabled: false" vr-mode-ui="enabled: false">
      
      <a-entity camera look-controls position="0 1.6 0">
        <a-entity id="cursor-visual" 
                  cursor="fuse: false; raycaster: .clickable"
                  raycaster="objects: .clickable; far: 20"
                  position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                  material="color: white; shader: flat; opacity: 0.8">
        </a-entity>
      </a-entity>

      <a-entity position="0 0 -3.8">
        <a-video src="#videoPlayer" width="5.2" height="2.9" position="-2.65 0 0"></a-video>
        <a-video src="#videoPlayer" width="5.2" height="2.9" position="2.65 0 0"></a-video>

        <a-circle class="clickable" data-action="prev" position="-0.8 -2 0.5" radius="0.35" color="#00d4ff" opacity="0.9">
          <a-text value="<" align="center" position="0 0 0.05" scale="2 2 2" color="#000"></a-text>
        </a-circle>
        
        <a-circle class="clickable" data-action="next" position="0.8 -2 0.5" radius="0.35" color="#00d4ff" opacity="0.9">
          <a-text value=">" align="center" position="0 0 0.05" scale="2 2 2" color="#000"></a-text>
        </a-circle>

      </a-entity>

      <a-sky color="#050505"></a-sky>
    </a-scene>
  </div>

  <div class="container">
    <h1>IPTV VR Shinacon</h1>
    
    <div class="input-group">
      <input id="urlInput" type="text" placeholder="Pega enlace m3u8 o mp4..." />
      <button id="btnLoadUrl">Ver Canal</button>
      <button onclick="toggleVR()" class="btn-vr">ENTRAR VR</button>
    </div>

    <div class="input-group">
      <input id="fileInput" type="file" accept=".m3u" style="color:white">
      <button id="btnLoadFile" style="background:#444;color:#fff">Cargar Lista</button>
    </div>

    <div id="lista" class="channel-list"></div>
  </div>

  <script type="module">
    import Hls from "hls.js";

    // --- LÓGICA DEL REPRODUCTOR ---
    const video = document.getElementById('videoPlayer');
    const state = { channels: [], index: 0 };
    let hls = null;

    window.toggleVR = () => {
      const isVr = document.body.classList.toggle('is-vr');
      if(isVr) document.documentElement.requestFullscreen().catch(()=>{});
      else if(document.fullscreenElement) document.exitFullscreen();
    };

    function playUrl(url) {
      if(hls) { hls.destroy(); hls = null; }
      if(url.includes('.m3u8')) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else {
        video.src = url;
        video.play();
      }
    }

    function changeChannel(dir) {
      if(state.channels.length === 0) return;
      state.index = (state.index + dir + state.channels.length) % state.channels.length;
      playUrl(state.channels[state.index].url);
      
      // Feedback visual temporal (Opcional: un parpadeo en consola o pantalla)
      console.log("Cambiando canal a: " + state.channels[state.index].title);
    }

    // --- MANEJO DE LISTAS ---
    function renderList() {
      const el = document.getElementById('lista');
      el.innerHTML = state.channels.map((c,i) => 
        `<div class="item" onclick="playIndex(${i})">${c.title}</div>`
      ).join('');
    }
    
    window.playIndex = (i) => { state.index = i; playUrl(state.channels[i].url); }

    document.getElementById('btnLoadUrl').onclick = () => {
      const url = document.getElementById('urlInput').value;
      if(url) { state.channels = [{title:"Canal Manual", url}]; state.index=0; playUrl(url); renderList(); }
    }

    document.getElementById('btnLoadFile').onclick = async () => {
      const file = document.getElementById('fileInput').files[0];
      if(!file) return;
      const text = await file.text();
      const lines = text.split('\n');
      state.channels = [];
      lines.forEach((line, i) => {
        if(line.startsWith('#EXTINF')) {
          state.channels.push({title: line.split(',')[1] || "Canal", url: lines[i+1].trim()});
        }
      });
      renderList();
    }

    // ==========================================================
    // === SOLUCIÓN "GATILLO UNIVERSAL" PARA CONTROL MÓVIL ===
    // ==========================================================
    
    // Esta función se ejecuta CADA VEZ que haces clic en la pantalla 
    // (con el dedo o con el botón del control mouse).
    function universalClicker(e) {
      // 1. Solo actuar si estamos en modo VR
      if (!document.body.classList.contains('is-vr')) return;

      // 2. Buscar qué está mirando el aro blanco ahora mismo
      const cursor = document.getElementById('cursor-visual');
      const raycaster = cursor.components.raycaster; // Obtener componente interno de A-Frame
      const intersected = raycaster.intersectedEls;  // Lista de objetos que el rayo toca

      if (intersected.length > 0) {
        // 3. Si estamos mirando algo, obtener el elemento
        const target = intersected[0];
        
        // 4. Ver si tiene una acción definida (prev/next)
        const action = target.getAttribute('data-action');
        
        if (action === 'prev') changeChannel(-1);
        if (action === 'next') changeChannel(1);
        
        // Efecto visual de "pulsado" (se hace pequeño y vuelve)
        target.setAttribute('scale', '0.9 0.9 0.9');
        setTimeout(() => target.setAttribute('scale', '1 1 1'), 150);
      }
    }

    // Escuchamos clics, toques y mousedown globales
    window.addEventListener('click', universalClicker);
    window.addEventListener('touchstart', universalClicker);
    
    // ==========================================================

  </script>
</body>
</html>