<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>IPTV & YT VR Final Fix</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    :root{--bg:#051019;--accent:#00d4ff;--danger:#ff4444;--success:#39ff14}
    *{box-sizing:border-box;font-family:sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;overflow:hidden}
    
    .container{max-width:980px;margin:12px auto;padding:15px;transition:opacity 0.3s}
    body.is-vr .container { opacity:0; pointer-events:none; position:absolute; z-index:-1 }
    
    /* CAPA VR Y YOUTUBE */
    #vr-layer { display:none; position:fixed; inset:0; z-index:9999; background:#000}
    body.is-vr #vr-layer { display:block }
    
    .video-container{background:#000; border-radius:12px; position:relative; overflow:hidden; width:100%; height:320px; border:1px solid #22303a;}
    #fullPlayerArea { width:100%; height:100%; position:relative; background:#000; display:flex; align-items:center }
    
    #videoPlayer, #webFrame { width:100%; height:100%; border:none; display:none; }

    /* TRUCO PARA VER YOUTUBE EN VR */
    body.is-vr.is-youtube #webFrame {
        display: block !important;
        position: fixed;
        width: 200%; /* Duplicamos el ancho */
        height: 100%;
        left: -50%; /* Centramos la vista dividida */
        z-index: 9998;
        pointer-events: none;
        filter: contrast(1.1);
    }

    #click-overlay { position: absolute; inset: 0; z-index: 10001; cursor: pointer; background: transparent; }
    #btn-exit-vr { position:fixed; top:15px; right:15px; z-index:10002; background:var(--danger); color:white; padding:12px 24px; border-radius:30px; font-weight:bold; border:2px solid white; cursor: pointer; }
    #feedback{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); color:#fff; padding:15px 25px; border-radius:30px; display:none; z-index:10005; pointer-events:none; border:1px solid var(--accent); white-space:nowrap; font-size: 20px; font-weight: bold; }

    .channel-list{background:#071018;border-radius:10px;padding:5px;max-height:160px;overflow:auto;border:1px solid #16202a;margin-bottom:10px}
    .channel-item{padding:12px;border-bottom:1px solid #16202a;cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    .channel-item.active{border-left:4px solid var(--accent); background:#111b25}
  </style>
  <script type="importmap">{ "imports": { "hls.js": "https://esm.sh/hls.js@1.4.12" } }</script>
</head>
<body class="">

  <div id="vr-layer">
    <div id="vr-click-surface" style="position:fixed; inset:0; z-index:10000;"></div>
    <button id="btn-exit-vr" onclick="window.toggleVR()">SALIR VR</button>
    <a-scene embedded loading-screen="enabled:false" vr-mode-ui="enabled:false" id="aScene">
      <a-entity camera look-controls position="0 1.6 0">
        <a-entity id="vr-display-container" position="0 0 -3.6">
          <a-video id="screenLeft" src="#videoPlayer" width="4.8" height="2.7" material="shader:flat"></a-video>
          <a-video id="screenRight" src="#videoPlayer" width="4.8" height="2.7" material="shader:flat"></a-video>
          <a-plane position="0 0 0.5" width="0.1" height="4" color="#000"></a-plane>
        </a-entity>
      </a-entity>
      <a-sky color="#000"></a-sky>
    </a-scene>
  </div>

  <div class="container">
    <h2 style="text-align:center; color:var(--accent)">IPTV & YouTube VR Pro</h2>
    <div class="input-section">
      <input id="urlIn" type="text" placeholder="URL M3U8 o YouTube..." />
      <button onclick="window.addUrl()" class="btn-load">AÑADIR</button>
    </div>
    <div style="display:flex; gap:10px; margin-bottom:10px">
        <button onclick="window.toggleFS()" class="btn-fs" style="flex:1">PANTALLA COMPLETA</button>
        <button onclick="window.toggleVR()" class="btn-vr" style="flex:1">MODO VR</button>
    </div>
    <div class="channel-list" id="list"></div>
    <div class="video-container" id="mainVideoContainer">
      <div id="fullPlayerArea">
        <div id="click-overlay"></div>
        <div id="feedback"></div>
        <video id="videoPlayer" crossorigin="anonymous" playsinline webkit-playsinline></video>
        <iframe id="webFrame" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import Hls from "hls.js";
    const STORAGE_KEY = 'iptv_master_v4';
    const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { channels: [], current: -1, eyeGap: 2.15 };
    const state = { ...savedData };
    const video = document.getElementById('videoPlayer');
    const iframe = document.getElementById('webFrame');
    const scene = document.getElementById('aScene');
    let hls = null;

    function getYTID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    window.playUrl = (rawUrl, index) => {
        if(hls){ hls.destroy(); hls = null; }
        video.pause(); video.src = ""; iframe.src = "";
        state.current = index;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        render();

        const ytID = getYTID(rawUrl);
        if (ytID) {
            document.body.classList.add('is-youtube');
            iframe.style.display = "block"; video.style.display = "none";
            iframe.src = `https://www.youtube.com/embed/${ytID}?autoplay=1&controls=0&iv_load_policy=3&rel=0`;
            scene.setAttribute('visible', 'false'); // Ocultamos A-Frame para ver el iframe detrás
        } else {
            document.body.classList.remove('is-youtube');
            iframe.style.display = "none"; video.style.display = "block";
            scene.setAttribute('visible', 'true');
            if (rawUrl.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    hls = new Hls(); hls.loadSource(rawUrl); hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                } else { video.src = rawUrl; video.play(); }
            } else { video.src = rawUrl; video.play(); }
        }
    };

    window.addUrl = () => {
        const val = document.getElementById('urlIn').value.trim();
        if(val) {
            state.channels.push({title: "Canal " + (state.channels.length + 1), url: val});
            document.getElementById('urlIn').value = "";
            window.playUrl(val, state.channels.length - 1);
        }
    };

    window.playNext = () => {
        if(!state.channels.length) return;
        const next = (state.current + 1) % state.channels.length;
        window.playUrl(state.channels[next].url, next);
        showFeedback("SIGUIENTE");
    };

    window.toggleVR = () => {
        document.body.classList.toggle('is-vr');
        if (document.body.classList.contains('is-vr')) {
            document.documentElement.requestFullscreen();
            const L = document.getElementById('screenLeft'), R = document.getElementById('screenRight');
            L.setAttribute('position', `-${state.eyeGap} 0 0`);
            R.setAttribute('position', `${state.eyeGap} 0 0`);
        }
    };

    window.toggleFS = () => {
        if (!document.fullscreenElement) document.getElementById('fullPlayerArea').requestFullscreen();
        else document.exitFullscreen();
    };

    function showFeedback(t) {
        const f = document.getElementById('feedback');
        f.textContent = t; f.style.display = "block";
        setTimeout(() => f.style.display = "none", 1000);
    }

    function render() {
        const l = document.getElementById('list');
        l.innerHTML = state.channels.map((ch, i) => `
            <div class="channel-item ${state.current === i ? 'active' : ''}" onclick="window.playUrl('${ch.url}', ${i})">
                ${ch.title} <small>${ch.url.substring(0,20)}...</small>
            </div>`).join('') || '<div style="text-align:center;padding:10px">Vacío</div>';
    }

    // INTERACCIÓN UNIFICADA
    const action = (e) => {
        if (e.target.tagName === 'INPUT' || e.target.id === 'btn-exit-vr') return;
        window.playNext();
    };
    document.getElementById('click-overlay').onclick = action;
    document.getElementById('vr-click-surface').onclick = action;
    window.onkeydown = (e) => { if(e.code === 'Space' || e.code === 'Enter') window.playNext(); };

    render();
    if(state.current >= 0) window.playUrl(state.channels[state.current].url, state.current);
  </script>
</body>
</html>