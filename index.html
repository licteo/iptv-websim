<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Reproductor IPTV Universal VR</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <style>
    :root{--accent:#00d4ff;--bg:#0f1720;--card:#1a242f}
    body{margin:0;background:var(--bg);color:white;font-family:system-ui;overflow-x:hidden}
    
    .container{padding:15px;max-width:800px;margin:auto}
    .panel{background:var(--card);padding:15px;border-radius:12px;border:1px solid #2c3e50;margin-bottom:15px}
    
    input{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid #34495e;background:#000;color:white;box-sizing:border-box}
    button{width:100%;padding:12px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
    
    .vr-toggle{display:flex;align-items:center;gap:10px;margin:10px 0;padding:10px;background:#000;border-radius:8px}

    #display-area{width:100%;height:350px;background:#000;border-radius:12px;overflow:hidden;position:relative}
    video, iframe{width:100%;height:100%;border:none}
    
    /* VR Scene Viewport */
    a-scene{display:none;width:100%;height:100%}
    .vr-active a-scene{display:block}
    .vr-active #normalPlayer, .vr-active #ytPlayer{display:none}

    @media (max-width:640px){ #display-area{height:250px} }
  </style>

  <script type="importmap">
    { "imports": { "hls.js": "https://esm.sh/hls.js@1.4.12" } }
  </script>
</head>
<body>

  <div class="container">
    <h1 style="text-align:center; color:var(--accent)">IPTV VR Cinema</h1>

    <div class="panel">
      <input id="videoUrl" type="text" placeholder="Pega URL de YouTube o lista .m3u8">
      <button id="btnPlay">REPRODUCIR AHORA</button>
      
      <div class="vr-toggle">
        <input type="checkbox" id="modeVR" style="width:auto; margin:0">
        <label for="modeVR">ðŸ‘“ Activar InmersiÃ³n VR (Giroscopio)</label>
      </div>
    </div>

    <div id="display-area">
      <video id="normalPlayer" controls playsinline></video>
      
      <div id="ytPlayer" style="display:none; width:100%; height:100%;"></div>

      <a-scene id="vrScene" embedded device-orientation-permission-ui="enabled: true">
        <a-assets>
          <video id="assetVideo" autoplay crossorigin="anonymous" playsinline></video>
        </a-assets>
        
        <a-video id="vrScreen" src="#assetVideo" width="16" height="9" position="0 1.6 -10"></a-video>
        
        <a-sky color="#000"></a-sky>
        
        <a-entity camera look-controls position="0 1.6 0">
           <a-cursor color="#00d4ff"></a-cursor>
        </a-entity>
      </a-scene>
    </div>
    
    <p style="font-size: 12px; color: #7f8c8d; text-align: center; margin-top: 10px;">
      Nota: Para YouTube en VR, usa el botÃ³n nativo de YouTube dentro del reproductor.
    </p>
  </div>

  <script type="module">
    import Hls from "hls.js";

    const btnPlay = document.getElementById('btnPlay');
    const inputUrl = document.getElementById('videoUrl');
    const checkVR = document.getElementById('modeVR');
    const display = document.getElementById('display-area');
    
    const vNormal = document.getElementById('normalPlayer');
    const vVR = document.getElementById('assetVideo');
    const ytCont = document.getElementById('ytPlayer');
    const hls = new Hls();

    btnPlay.addEventListener('click', () => {
      const url = inputUrl.value.trim();
      const useVR = checkVR.checked;

      // Reset
      display.classList.remove('vr-active');
      vNormal.style.display = 'none';
      ytCont.style.display = 'none';
      vNormal.pause();
      vVR.pause();

      if (url.includes("youtube.com") || url.includes("youtu.be")) {
        // MODO YOUTUBE (Evita Error 153)
        const id = getYTID(url);
        ytCont.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1" allow="accelerometer; autoplay; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        ytCont.style.display = 'block';
      } else {
        // MODO IPTV / DIRECTO
        if (useVR) {
          display.classList.add('vr-active');
          loadMedia(vVR, url);
        } else {
          vNormal.style.display = 'block';
          loadMedia(vNormal, url);
        }
      }
    });

    function loadMedia(videoEl, url) {
      if (Hls.isSupported() && url.includes(".m3u8")) {
        hls.destroy();
        const newHls = new Hls();
        newHls.loadSource(url);
        newHls.attachMedia(videoEl);
        newHls.on(Hls.Events.MANIFEST_PARSED, () => videoEl.play());
      } else {
        videoEl.src = url;
        videoEl.play();
      }
    }

    function getYTID(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length == 11) ? match[2] : null;
    }
  </script>
</body>
</html>