<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>IPTV VR Ultimate Pro</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <style>
    :root{--bg:#051019;--accent:#00d4ff;--danger:#ff4444;--success:#39ff14}
    *{box-sizing:border-box;font-family:sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;overflow:hidden}
    
    .container{max-width:980px;margin:12px auto;padding:15px;transition:opacity 0.3s}
    body.is-vr .container { opacity:0; pointer-events:none; position:absolute; z-index:-1 }
    
    .input-section{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
    input{flex:1;padding:12px;border-radius:8px;border:1px solid #22303a;background:#0b1115;color:#fff;font-size:16px}
    button{border:none;padding:12px;border-radius:8px;font-weight:bold;cursor:pointer}
    
    .btn-load{background:var(--accent); color:#000}
    .btn-fs{background:var(--success); color:#000}
    .btn-vr{background:#ff00ff; color:#fff}
    .btn-clear{background:#444; color:#fff; font-size:11px; padding:5px 10px}

    .channel-list{background:#071018;border-radius:10px;padding:5px;max-height:160px;overflow:auto;border:1px solid #16202a;margin-bottom:10px}
    .channel-item{padding:12px;border-bottom:1px solid #16202a;cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    .channel-item:hover{background:#111b25}
    .channel-item.active{border-left:4px solid var(--accent); background:#111b25}

    /* CAPA VR */
    #vr-layer { display:none; position:fixed; inset:0; z-index:9999; background:#000 }
    body.is-vr #vr-layer { display:block }
    
    #btn-exit-vr { position:fixed; top:15px; right:15px; z-index:10000; background:var(--danger); color:white; padding:10px 20px; border-radius:20px; font-weight:bold; border:2px solid white }

    /* LÍNEA GUÍA CENTRAL PARA ALINEAR GAFAS */
    #center-guide {
        position: fixed;
        top: 0; bottom: 0; left: 50%;
        width: 2px;
        background: rgba(255, 255, 255, 0.4); /* Blanco semi-transparente */
        transform: translateX(-50%);
        z-index: 9998;
        pointer-events: none; /* Permite clics a través de ella */
    }

    #vr-web-msg { display:none; position:fixed; top:50%; width:100%; text-align:center; color:yellow; font-weight:bold; z-index:10001; text-shadow:2px 2px #000 }
    
    #vr-controls-hint { position:fixed; bottom:20px; width:100%; text-align:center; color:rgba(255,255,255,0.5); font-size:12px; z-index:10002; pointer-events:none; display:none }
    body.is-vr #vr-controls-hint { display:block }

    .video-container{background:#000; border-radius:12px; position:relative; overflow:hidden; width:100%; height:320px; border:1px solid #22303a}
    #fullPlayerArea { width:100%; height:100%; position:relative; background:#000; display:flex; align-items:center }
    
    #videoPlayer, #webFrame { width:100%; height:100%; border:none; display:none }
    video { object-fit:contain }

    .touch-zone { position:absolute; top:0; bottom:80px; width:35%; z-index:5 }
    .left-zone { left:0 }
    .right-zone { right:0 }
    
    #feedback{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); color:#fff; padding:15px 25px; border-radius:30px; display:none; z-index:10005; pointer-events:none; border:1px solid var(--accent); white-space:nowrap; font-size: 18px; font-weight: bold; }

    @media (max-width:640px){ .video-container{height:230px} }
  </style>

  <script type="importmap">{ "imports": { "hls.js": "https://esm.sh/hls.js@1.4.12" } }</script>
</head>
<body>

  <div id="vr-layer">
    <button id="btn-exit-vr" onclick="window.toggleVR()">SALIR DE VR</button>
    <div id="center-guide"></div>
    
    <div id="vr-web-msg">Web no compatible con VR. Usa enlaces directos.</div>
    <div id="vr-controls-hint">Toque ARRIBA: Separar | ABAJO: Juntar | CENTRO: Cambiar Canal</div>

    <a-scene embedded loading-screen="enabled:false" vr-mode-ui="enabled:false">
      <a-entity camera look-controls position="0 1.6 0">
        <a-entity position="0 0 -3.6">
          <a-video id="screenLeft" src="#videoPlayer" width="4.8" height="2.7" position="-2.15 0 0" material="shader:flat"></a-video>
          <a-video id="screenRight" src="#videoPlayer" width="4.8" height="2.7" position="2.15 0 0" material="shader:flat"></a-video>
          <a-plane position="0 0 0.5" width="0.4" height="4" color="#000" material="shader:flat"></a-plane>
        </a-entity>
      </a-entity>
      <a-sky color="#000"></a-sky>
    </a-scene>
  </div>

  <div class="container">
    <h1 style="text-align:center; color:var(--accent); margin:0 0 10px 0; font-size:22px">IPTV VR Player</h1>
    
    <div class="input-section">
      <input id="urlIn" type="text" placeholder="Pega URL (.m3u8, .mp4 o Web)" />
      <button onclick="window.addUrl()" class="btn-load">AGREGAR</button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <button onclick="window.toggleFS()" class="btn-fs">PANTALLA COMPLETA</button>
        <button onclick="window.toggleVR()" class="btn-vr">MODO VR</button>
        <button onclick="window.clearAll()" class="btn-clear">Limpiar Lista</button>
    </div>

    <div class="channel-list" id="list"></div>

    <div class="video-container">
      <div id="fullPlayerArea">
        <div id="feedback"></div>
        <div class="touch-zone left-zone" onclick="window.playPrev()"></div>
        <div class="touch-zone right-zone" onclick="window.playNext()"></div>
        
        <video id="videoPlayer" crossorigin="anonymous" playsinline webkit-playsinline controls></video>
        <iframe id="webFrame" allow="autoplay; fullscreen; encrypted-media"></iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import Hls from "hls.js";

    const saved = JSON.parse(localStorage.getItem('iptv_data_v2')) || { channels: [], last: -1, eyeGap: 2.15 };
    const state = { channels: saved.channels, current: saved.last, eyeGap: saved.eyeGap };
    
    const video = document.getElementById('videoPlayer');
    const iframe = document.getElementById('webFrame');
    const feedback = document.getElementById('feedback');
    const vrMsg = document.getElementById('vr-web-msg');
    let hls = null;

    function updateEyeGap() {
        const left = document.getElementById('screenLeft');
        const right = document.getElementById('screenRight');
        if(left && right) {
            left.object3D.position.x = -state.eyeGap;
            right.object3D.position.x = state.eyeGap;
            if(document.body.classList.contains('is-vr')){
                showFeedback(`Separación: ${state.eyeGap.toFixed(2)}`);
            }
            window.save();
        }
    }

    function adjustEyes(delta) {
        state.eyeGap += delta;
        if(state.eyeGap < 1.0) state.eyeGap = 1.0;
        if(state.eyeGap > 3.5) state.eyeGap = 3.5;
        updateEyeGap();
    }

    function refreshVR() {
      if (video.style.display !== "none" && video.paused && video.src) {
        video.play().catch(() => {});
      }
      const vrScreens = document.querySelectorAll('a-video');
      vrScreens.forEach(s => {
        const mesh = s.getObject3D('mesh');
        if(mesh && mesh.material.map) mesh.material.map.needsUpdate = true;
      });
      updateEyeGap();
    }

    window.save = () => {
        localStorage.setItem('iptv_data_v2', JSON.stringify({
            channels: state.channels,
            last: state.current,
            eyeGap: state.eyeGap
        }));
    };

    window.playUrl = async (url, index) => {
      state.current = index;
      window.save();
      render();

      if(hls){ hls.destroy(); hls = null; }
      
      const isM3U8 = url.toLowerCase().includes('.m3u8');
      const isVideoFile = url.match(/\.(mp4|webm|avi|mov)$/i);

      if (isM3U8 || isVideoFile) {
        iframe.style.display = "none";
        iframe.src = "";
        video.style.display = "block";
        vrMsg.style.display = "none";

        if (Hls.isSupported() && isM3U8) {
          hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video.play().catch(()=>{});
            setTimeout(refreshVR, 500);
          });
        } else { 
          video.src = url; 
          video.load();
          video.play().catch(()=>{}); 
          setTimeout(refreshVR, 500);
        }
      } else {
        video.style.display = "none";
        video.pause();
        video.src = "";
        iframe.style.display = "block";
        iframe.src = url;
        if(document.body.classList.contains('is-vr')) vrMsg.style.display = "block";
      }
    };

    window.addUrl = () => {
      const input = document.getElementById('urlIn');
      if(input.value.trim()){
        state.channels.push({title: "Canal " + (state.channels.length + 1), url: input.value.trim()});
        input.value = "";
        window.save();
        render();
        window.playUrl(state.channels[state.channels.length-1].url, state.channels.length-1);
      }
    };

    window.playNext = () => {
      if(state.channels.length === 0) return;
      let next = (state.current + 1) % state.channels.length;
      showFeedback("SIGUIENTE ▶");
      window.playUrl(state.channels[next].url, next);
    };

    window.playPrev = () => {
      if(state.channels.length === 0) return;
      let prev = (state.current - 1 + state.channels.length) % state.channels.length;
      showFeedback("◀ ANTERIOR");
      window.playUrl(state.channels[prev].url, prev);
    };

    window.toggleFS = async () => {
      const area = document.getElementById('fullPlayerArea');
      if (!document.fullscreenElement) {
        if (area.requestFullscreen) await area.requestFullscreen();
        screen.orientation?.lock('landscape').catch(()=>{});
      } else {
        document.exitFullscreen();
      }
    };

    window.toggleVR = async () => {
      const isEntering = !document.body.classList.contains('is-vr');
      document.body.classList.toggle('is-vr');
      if (isEntering) {
        document.documentElement.requestFullscreen?.();
        if(iframe.style.display === "block") vrMsg.style.display = "block";
        setTimeout(refreshVR, 800);
      } else {
        vrMsg.style.display = "none";
        document.exitFullscreen?.();
      }
    };

    window.clearAll = () => {
      if(confirm("¿Borrar todo?")) {
        state.channels = []; state.current = -1;
        window.save(); render();
        video.src = ""; iframe.src = "";
      }
    };

    function showFeedback(txt) {
      feedback.textContent = txt;
      feedback.style.display = "block";
      setTimeout(() => feedback.style.display = "none", 1500);
    }

    function render() {
      const listDiv = document.getElementById('list');
      if(state.channels.length === 0) {
        listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#444">Lista vacía.</div>';
        return;
      }
      listDiv.innerHTML = state.channels.map((ch, i) => 
        `<div class="channel-item ${state.current === i ? 'active' : ''}" onclick="window.playUrl('${ch.url}', ${i})">
            <span>${ch.title}</span>
            <span style="color:var(--accent); font-size:10px">PLAY</span>
         </div>`
      ).join('');
    }

    render();
    if(state.current >= 0 && state.channels[state.current]) {
        window.playUrl(state.channels[state.current].url, state.current);
    }

    // --- CONTROLES ZONALES Y BLUETOOTH ---

    window.addEventListener('touchstart', (e) => {
      if (!document.body.classList.contains('is-vr')) return; 
      if (e.target.id === 'btn-exit-vr') return;

      const touchY = e.touches[0].clientY;
      const screenHeight = window.innerHeight;

      // ARRIBA (25%) -> Separar
      // ABAJO (25%) -> Juntar
      // CENTRO (50%) -> Cambiar Canal

      if (touchY < screenHeight * 0.25) {
          adjustEyes(0.1); 
      } else if (touchY > screenHeight * 0.75) {
          adjustEyes(-0.1); 
      } else {
          window.playNext();
          setTimeout(refreshVR, 600);
      }
    });

    window.addEventListener('keydown', (e) => {
      if (!document.body.classList.contains('is-vr')) return;

      const k = e.code;
      const isUp = k === 'ArrowUp' || k === 'PageUp' || k === 'KeyW';
      const isDown = k === 'ArrowDown' || k === 'PageDown' || k === 'KeyS';
      const isAction = k === 'Enter' || k === 'Space' || k === 'NumpadEnter';

      if (isUp) { e.preventDefault(); adjustEyes(0.05); } 
      else if (isDown) { e.preventDefault(); adjustEyes(-0.05); }
      else if (isAction) { window.playNext(); setTimeout(refreshVR, 600); }
    });
    
    window.addEventListener('click', (e) => {
       if(document.body.classList.contains('is-vr') && e.target.id !== 'btn-exit-vr') {
           window.playNext();
           setTimeout(refreshVR, 600);
       }
    });

  </script>
</body>
</html>