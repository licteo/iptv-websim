<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="IPTV Player" />
  <meta name="theme-color" content="#00d4ff" />
  <title>Reproductor IPTV con VR</title>

  <style>
    :root{--bg:#0f1720;--card:#141922;--muted:#9aa4af;--accent:#00d4ff;--danger:#ff4444}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#051019 0%, #071424 100%);color:#e6eef6}
    .container{max-width:980px;margin:18px auto;padding:18px}
    h1{margin:0 0 12px 0;font-size:20px;text-align:center;color:var(--accent)}
    .input-section{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
    input[type="text"]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid #22303a;background:#0b1115;color:#e6eef6}
    .file-input{padding:8px}
    button{background:var(--accent);color:#002;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:500}
    .btn-secondary{background:#2b3940;color:#e6eef6}
    .btn-danger{background:var(--danger)}
    .search-container{flex:1;display:flex;align-items:center;gap:6px}
    .search-input{flex:1;padding:8px;border-radius:8px;border:1px solid #22303a;background:#071018;color:#e6eef6}
    .favorites-toggle{display:flex;align-items:center;gap:6px;color:var(--muted)}
    .channel-list{margin-top:10px;background:linear-gradient(180deg,#071018,#061014);border-radius:10px;padding:8px;min-height:80px;max-height:240px;overflow:auto;border:1px solid #16202a}
    .channel-item{padding:10px;border-radius:8px;background:transparent;border:1px solid transparent;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;cursor:pointer}
    .channel-item:hover{background:#081118;border-color:#16313d}
    .star{background:transparent;border:0;color:var(--muted);font-size:18px;cursor:pointer}
    .video-container{margin-top:12px;background:var(--card);padding:8px;border-radius:10px;border:1px solid #16202a}
    .player-shell{width:100%;height:520px;border-radius:6px;overflow:hidden;background:black;display:block;position:relative}
    video, iframe{width:100%;height:100%;display:block;border-radius:6px;background:black;border:0}
    .channel-controls{display:flex;gap:8px;align-items:center;margin-top:8px;justify-content:center;flex-wrap:wrap}
    .channel-btn{padding:8px 12px;border-radius:6px;border:0;background:#0b1318;color:#dfeafb;cursor:pointer}
    .vr-btn{background:#8b5cf6;color:white;font-weight:600;padding:10px 16px}
    .vr-btn:hover{background:#7c3aed}
    .vr-btn.active{background:#22c55e}
    .current-channel-info{color:var(--muted);font-size:14px}
    .loading{position:relative;text-align:center;color:var(--muted);padding:6px;font-size:14px}
    .empty-message{color:var(--muted);margin:12px 0;text-align:center}
    .vr-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;flex-direction:column;gap:16px;z-index:100;border-radius:6px}
    .vr-overlay.active{display:flex}
    .vr-info{color:white;font-size:16px;text-align:center;padding:0 20px}
    .vr-exit-btn{background:#ff4444;color:white;padding:12px 24px;border-radius:8px;border:0;cursor:pointer;font-size:16px;font-weight:600}
    @media (max-width:900px){
      .player-shell{height:420px}
    }
    @media (max-width:640px){
      .player-shell{height:320px}
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "hls.js": "https://esm.sh/hls.js@1.4.12",
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
  </script>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ¬ Reproductor IPTV con VR</h1>

    <div class="input-section">
      <input id="channelUrl" type="text" placeholder="Pega la URL del canal (.m3u8, mp4, youtube...)" />
      <button id="loadChannel">Cargar Canal</button>
    </div>

    <div class="input-section">
      <input id="m3uFile" type="file" accept=".m3u,.m3u8" class="file-input" />
      <button id="loadList" class="btn-secondary">Cargar Lista M3U</button>
      <button id="clearList" class="btn-danger">Limpiar Lista</button>
    </div>

    <div class="input-section">
      <div class="search-container">
        <input id="searchInput" class="search-input" placeholder="Buscar canal..." />
      </div>
      <label class="favorites-toggle">
        <input id="favoritesToggle" type="checkbox" />
        <span class="toggle-label">â˜… Solo Favoritos</span>
      </label>
    </div>

    <div id="channelList" class="channel-list">
      <p class="empty-message">No hay canales cargados</p>
    </div>

    <div class="video-container" id="playerArea">
      <div id="playerRoot" class="player-shell">
        <video id="videoPlayer" controls playsinline webkit-playsinline crossorigin="anonymous"></video>
        <div id="vrOverlay" class="vr-overlay">
          <div class="vr-info">ðŸ¥½ Modo VR Activado<br>Mueve tu dispositivo o usa el mouse para mirar alrededor</div>
          <button id="exitVR" class="vr-exit-btn">Salir de VR</button>
        </div>
      </div>
      <div id="loading" class="loading" style="display:none">Cargando...</div>

      <div class="channel-controls">
        <button id="prevChannel" class="channel-btn">â—€ Anterior</button>
        <button id="favoriteCurrent" class="channel-btn" title="Marcar como favorito">â˜…</button>
        <button id="vrToggle" class="vr-btn">ðŸ¥½ Modo VR 360Â°</button>
        <span id="currentChannelInfo" class="current-channel-info"></span>
        <button id="nextChannel" class="channel-btn">Siguiente â–¶</button>
      </div>
    </div>
  </div>

  <script type="module">
    import Hls from "hls.js";
    import * as THREE from "three";

    // Estado
    const state = {
      channels: [],
      currentIndex: -1,
      vrMode: false
    };

    // Elementos
    const channelUrl = document.getElementById('channelUrl');
    const loadChannelBtn = document.getElementById('loadChannel');
    const m3uFile = document.getElementById('m3uFile');
    const loadListBtn = document.getElementById('loadList');
    const clearListBtn = document.getElementById('clearList');
    const channelList = document.getElementById('channelList');
    const searchInput = document.getElementById('searchInput');
    const favoritesToggle = document.getElementById('favoritesToggle');
    const videoPlayer = document.getElementById('videoPlayer');
    const playerRoot = document.getElementById('playerRoot');
    const loading = document.getElementById('loading');
    const prevChannelBtn = document.getElementById('prevChannel');
    const nextChannelBtn = document.getElementById('nextChannel');
    const favoriteCurrentBtn = document.getElementById('favoriteCurrent');
    const currentChannelInfo = document.getElementById('currentChannelInfo');
    const vrToggle = document.getElementById('vrToggle');
    const vrOverlay = document.getElementById('vrOverlay');
    const exitVRBtn = document.getElementById('exitVR');

    let hls = null;
    let vrScene = null;

    // ----------------- VR Scene Setup -----------------
    class VRScene {
      constructor(container, video) {
        this.container = container;
        this.video = video;
        this.isActive = false;
        
        // Three.js setup
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        this.camera.position.set(0, 0, 0.1);
        
        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(container.clientWidth, container.clientHeight);
        this.renderer.domElement.style.position = 'absolute';
        this.renderer.domElement.style.top = '0';
        this.renderer.domElement.style.left = '0';
        this.renderer.domElement.style.borderRadius = '6px';
        
        // Create sphere for 360 video
        const geometry = new THREE.SphereGeometry(500, 60, 40);
        geometry.scale(-1, 1, 1); // Invert sphere
        
        this.videoTexture = new THREE.VideoTexture(video);
        this.videoTexture.minFilter = THREE.LinearFilter;
        this.videoTexture.magFilter = THREE.LinearFilter;
        
        const material = new THREE.MeshBasicMaterial({ map: this.videoTexture });
        this.sphere = new THREE.Mesh(geometry, material);
        this.scene.add(this.sphere);
        
        // Controls
        this.lat = 0;
        this.lon = 0;
        this.phi = 0;
        this.theta = 0;
        this.isUserInteracting = false;
        this.onPointerDownPointerX = 0;
        this.onPointerDownPointerY = 0;
        this.onPointerDownLon = 0;
        this.onPointerDownLat = 0;
        
        this.setupControls();
      }
      
      setupControls() {
        const canvas = this.renderer.domElement;
        
        canvas.addEventListener('pointerdown', (e) => {
          this.isUserInteracting = true;
          this.onPointerDownPointerX = e.clientX;
          this.onPointerDownPointerY = e.clientY;
          this.onPointerDownLon = this.lon;
          this.onPointerDownLat = this.lat;
        });
        
        canvas.addEventListener('pointermove', (e) => {
          if (this.isUserInteracting) {
            this.lon = (this.onPointerDownPointerX - e.clientX) * 0.1 + this.onPointerDownLon;
            this.lat = (e.clientY - this.onPointerDownPointerY) * 0.1 + this.onPointerDownLat;
          }
        });
        
        canvas.addEventListener('pointerup', () => {
          this.isUserInteracting = false;
        });
        
        // Touch support
        canvas.addEventListener('touchstart', (e) => {
          if (e.touches.length === 1) {
            this.isUserInteracting = true;
            this.onPointerDownPointerX = e.touches[0].clientX;
            this.onPointerDownPointerY = e.touches[0].clientY;
            this.onPointerDownLon = this.lon;
            this.onPointerDownLat = this.lat;
          }
        });
        
        canvas.addEventListener('touchmove', (e) => {
          if (this.isUserInteracting && e.touches.length === 1) {
            this.lon = (this.onPointerDownPointerX - e.touches[0].clientX) * 0.1 + this.onPointerDownLon;
            this.lat = (e.touches[0].clientY - this.onPointerDownPointerY) * 0.1 + this.onPointerDownLat;
          }
        });
        
        canvas.addEventListener('touchend', () => {
          this.isUserInteracting = false;
        });
        
        // Mouse wheel zoom
        canvas.addEventListener('wheel', (e) => {
          e.preventDefault();
          const fov = this.camera.fov + e.deltaY * 0.05;
          this.camera.fov = Math.max(30, Math.min(120, fov));
          this.camera.updateProjectionMatrix();
        });
        
        // Device orientation for mobile VR
        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', (e) => {
            if (this.isActive && e.alpha !== null) {
              this.lon = e.alpha - 180;
              this.lat = e.beta - 90;
            }
          });
        }
      }
      
      activate() {
        if (this.isActive) return;
        this.isActive = true;
        
        // Hide video element
        this.video.style.display = 'none';
        
        // Add renderer to container
        this.container.appendChild(this.renderer.domElement);
        vrOverlay.classList.add('active');
        
        // Start animation loop
        this.animate();
        
        // Handle resize
        this.resizeHandler = () => this.onWindowResize();
        window.addEventListener('resize', this.resizeHandler);
      }
      
      deactivate() {
        if (!this.isActive) return;
        this.isActive = false;
        
        // Show video element
        this.video.style.display = 'block';
        
        // Remove renderer
        if (this.renderer.domElement.parentNode) {
          this.renderer.domElement.parentNode.removeChild(this.renderer.domElement);
        }
        vrOverlay.classList.remove('active');
        
        window.removeEventListener('resize', this.resizeHandler);
      }
      
      animate() {
        if (!this.isActive) return;
        requestAnimationFrame(() => this.animate());
        
        this.lat = Math.max(-85, Math.min(85, this.lat));
        this.phi = THREE.MathUtils.degToRad(90 - this.lat);
        this.theta = THREE.MathUtils.degToRad(this.lon);
        
        const x = 500 * Math.sin(this.phi) * Math.cos(this.theta);
        const y = 500 * Math.cos(this.phi);
        const z = 500 * Math.sin(this.phi) * Math.sin(this.theta);
        
        this.camera.lookAt(x, y, z);
        this.renderer.render(this.scene, this.camera);
      }
      
      onWindowResize() {
        this.camera.aspect = this.container.clientWidth / this.container.clientHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
      }
      
      dispose() {
        this.deactivate();
        this.videoTexture.dispose();
        this.sphere.geometry.dispose();
        this.sphere.material.dispose();
        this.renderer.dispose();
      }
    }

    // ----------------- Utilities -----------------
    function showLoading(show=true){ loading.style.display = show ? 'block' : 'none' }
    function isYouTube(url){
      try{
        const u = new URL(url);
        return u.hostname.includes('youtube.com') || u.hostname.includes('youtu.be');
      }catch(e){
        return /youtu\.be|youtube\.com/.test(url);
      }
    }
    function isHls(url){
      return /\.m3u8($|\?)/i.test(url) || url.includes('.m3u8');
    }
    function canVideoPlay(url){
      return /\.(mp4|webm|ogg)(\?.*)?$/i.test(url);
    }

    // ----------------- VR Toggle -----------------
    function toggleVR() {
      state.vrMode = !state.vrMode;
      
      if (state.vrMode) {
        if (!vrScene) {
          vrScene = new VRScene(playerRoot, videoPlayer);
        }
        vrScene.activate();
        vrToggle.classList.add('active');
        vrToggle.textContent = 'âœ“ VR Activo';
      } else {
        if (vrScene) {
          vrScene.deactivate();
        }
        vrToggle.classList.remove('active');
        vrToggle.textContent = 'ðŸ¥½ Modo VR 360Â°';
      }
    }

    vrToggle.addEventListener('click', toggleVR);
    exitVRBtn.addEventListener('click', () => {
      if (state.vrMode) toggleVR();
    });

    // ----------------- Channel list rendering -----------------
    function saveStateToLocal(){
      localStorage.setItem('iptv_channels_v1', JSON.stringify(state.channels));
    }
    function loadStateFromLocal(){
      const raw = localStorage.getItem('iptv_channels_v1');
      if(raw) {
        try{ state.channels = JSON.parse(raw); } catch(e){ state.channels = [] }
      }
    }

    function renderList(){
      const q = (searchInput.value||'').toLowerCase().trim();
      const onlyFav = favoritesToggle.checked;
      channelList.innerHTML = '';
      const filtered = state.channels.filter(c=>{
        if(onlyFav && !c.favorite) return false;
        if(q && !(c.title||'').toLowerCase().includes(q) && !(c.url||'').toLowerCase().includes(q)) return false;
        return true;
      });
      if(filtered.length===0){
        channelList.innerHTML = '<p class="empty-message">No hay canales cargados</p>';
        return;
      }
      filtered.forEach((ch, idx)=>{
        const item = document.createElement('div');
        item.className = 'channel-item';
        item.onclick = () => { const realIndex = state.channels.indexOf(ch); playIndex(realIndex); };
        const left = document.createElement('div');
        left.innerHTML = `<strong style="display:block">${ch.title||ch.url}</strong><small style="color:var(--muted)">${ch.url}</small>`;
        const right = document.createElement('div');
        const star = document.createElement('button');
        star.className = 'star';
        star.innerText = ch.favorite ? 'â˜…' : 'â˜†';
        star.title = ch.favorite ? 'Quitar favorito' : 'Agregar favorito';
        star.onclick = (e) => { e.stopPropagation(); ch.favorite = !ch.favorite; star.innerText = ch.favorite ? 'â˜…' : 'â˜†'; saveStateToLocal(); renderList(); };
        right.appendChild(star);
        item.appendChild(left);
        item.appendChild(right);
        channelList.appendChild(item);
      });
    }

    // ----------------- Play logic -----------------
    async function attachHls(url){
      if(hls){ hls.destroy(); hls = null; }
      if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(videoPlayer);
        return new Promise((res, rej)=>{
          const onMediaAttached = () => {
            hls.on(Hls.Events.MANIFEST_PARSED, () => res());
            hls.on(Hls.Events.ERROR, (event, data) => {
              console.warn('HLS error', data);
            });
          };
          onMediaAttached();
        });
      } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        videoPlayer.src = url;
        return Promise.resolve();
      } else {
        return Promise.reject(new Error('HLS no soportado por este navegador.'));
      }
    }

    function embedYouTube(url){
      if(hls){ hls.destroy(); hls = null; }
      if(vrScene) vrScene.deactivate();
      playerRoot.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      try{
        const u = new URL(url);
        let videoId = null;
        if(u.hostname.includes('youtu.be')) videoId = u.pathname.slice(1);
        if(u.hostname.includes('youtube.com')){
          const p = u.searchParams.get('v');
          if(p) videoId = p;
          if(!videoId && u.pathname.startsWith('/embed/')) videoId = u.pathname.split('/embed/')[1];
        }
        if(videoId) iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0&autoplay=1`;
        else iframe.src = url;
      }catch(e){
        iframe.src = url;
      }
      playerRoot.appendChild(iframe);
      playerRoot.appendChild(vrOverlay);
    }

    function embedGenericPage(url){
      if(hls){ hls.destroy(); hls = null; }
      if(vrScene) vrScene.deactivate();
      playerRoot.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      iframe.src = url;
      iframe.style.border = '0';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      playerRoot.appendChild(iframe);
      playerRoot.appendChild(vrOverlay);
    }

    async function playUrl(url){
      showLoading(true);
      currentChannelInfo.textContent = url;
      
      // Deactivate VR if active
      if (state.vrMode) toggleVR();
      
      if(isYouTube(url)){
        try{
          embedYouTube(url);
        }finally{
          showLoading(false);
        }
        return;
      }
      
      playerRoot.innerHTML = '';
      playerRoot.appendChild(videoPlayer);
      playerRoot.appendChild(vrOverlay);
      videoPlayer.pause();
      videoPlayer.removeAttribute('src');
      videoPlayer.load();

      try{
        if(isHls(url)){
          await attachHls(url);
          try{ await videoPlayer.play(); }catch(e){}
        } else if (canVideoPlay(url)){
          videoPlayer.src = url;
          try{ await videoPlayer.play(); }catch(e){}
        } else {
          embedGenericPage(url);
        }
      }catch(err){
        console.error('Error reproduciendo:', err);
        alert('No se pudo reproducir la URL en este reproductor.');
      } finally {
        showLoading(false);
      }
    }

    function playIndex(i){
      if(i < 0 || i >= state.channels.length) return;
      state.currentIndex = i;
      const ch = state.channels[i];
      currentChannelInfo.textContent = ch.title || ch.url;
      playUrl(ch.url);
      saveStateToLocal();
      renderList();
    }

    function playNext(){
      if(state.channels.length === 0) return;
      const next = (state.currentIndex + 1) % state.channels.length;
      playIndex(next);
    }
    function playPrev(){
      if(state.channels.length === 0) return;
      let prev = state.currentIndex - 1;
      if(prev < 0) prev = state.channels.length - 1;
      playIndex(prev);
    }

    // ----------------- M3U parsing -----------------
    async function parseM3U(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const out = [];
      for(let i=0;i<lines.length;i++){
        const line = lines[i];
        if(line.startsWith('#EXTINF')){
          const comma = line.indexOf(',');
          const title = comma >= 0 ? line.slice(comma+1).trim() : line;
          let j = i+1;
          while(j < lines.length && lines[j].startsWith('#')) j++;
          if(j < lines.length){
            out.push({title: title || lines[j], url: lines[j], favorite:false});
            i = j;
          }
        } else if(!line.startsWith('#') && (line.startsWith('http') || line.startsWith('/'))){
          out.push({title: line, url: line, favorite:false});
        }
      }
      return out;
    }

    // ----------------- Events -----------------
    loadChannelBtn.addEventListener('click', ()=>{
      const url = (channelUrl.value||'').trim();
      if(!url){ alert('Pega una URL vÃ¡lida'); return; }
      state.channels.push({title: url, url, favorite:false});
      saveStateToLocal();
      renderList();
      playIndex(state.channels.length - 1);
      channelUrl.value = '';
    });

    loadListBtn.addEventListener('click', async ()=>{
      const file = m3uFile.files && m3uFile.files[0];
      if(!file){ alert('Selecciona un archivo .m3u'); return; }
      const text = await file.text();
      const parsed = await parseM3U(text);
      if(parsed.length === 0){ alert('No se encontraron entradas en la lista M3U'); return; }
      state.channels = state.channels.concat(parsed);
      saveStateToLocal();
      renderList();
      playIndex(state.channels.length - parsed.length);
      m3uFile.value = '';
    });

    clearListBtn.addEventListener('click', ()=>{
      if(!confirm('Â¿Deseas limpiar toda la lista de canales?')) return;
      state.channels = [];
      state.currentIndex = -1;
      if(state.vrMode) toggleVR();
      saveStateToLocal();
      renderList();
      if(hls){ hls.destroy(); hls = null; }
      playerRoot.innerHTML = '';
      playerRoot.appendChild(videoPlayer);
      playerRoot.appendChild(vrOverlay);
      videoPlayer.pause();
      videoPlayer.removeAttribute('src');
      videoPlayer.load();
      currentChannelInfo.textContent = '';
    });

    searchInput.addEventListener('input', renderList);
    favoritesToggle.addEventListener('change', renderList);
    nextChannelBtn.addEventListener('click', playNext);
    prevChannelBtn.addEventListener('click', playPrev);
    favoriteCurrentBtn.addEventListener('click', ()=>{
      if(state.currentIndex < 0) return;
      const ch = state.channels[state.currentIndex];
      ch.favorite = !ch.favorite;
      saveStateToLocal();
      renderList();
    });

    window.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowRight') playNext();
      if(e.key === 'ArrowLeft') playPrev();
    });

    loadStateFromLocal();
    renderList();

    (function autoLoadFromQuery(){
      try{
        const p = new URLSearchParams(location.search);
        const u = p.get('url');
        if(u){
          state.channels.unshift({title:u, url:u, favorite:false});
          saveStateToLocal();
          renderList();
          playIndex(0);
        }
      }catch(e){}
    })();

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }

    playerRoot.appendChild(videoPlayer);
    playerRoot.appendChild(vrOverlay);
  </script>
</body>
</html>