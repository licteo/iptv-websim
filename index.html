<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>IPTV VR Ultimate Pro v3.1</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <style>
    :root{--bg:#051019;--accent:#00d4ff;--danger:#ff4444;--success:#39ff14}
    *{box-sizing:border-box;font-family:sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;overflow:hidden}
    
    .container{max-width:980px;margin:12px auto;padding:15px;transition:opacity 0.3s}
    body.is-vr .container { opacity:0; pointer-events:none; position:absolute; z-index:-1 }
    
    .input-section{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
    input{flex:1;padding:12px;border-radius:8px;border:1px solid #22303a;background:#0b1115;color:#fff;font-size:16px}
    button{border:none;padding:12px;border-radius:8px;font-weight:bold;cursor:pointer}
    
    .btn-load{background:var(--accent); color:#000}
    .btn-fs{background:var(--success); color:#000}
    .btn-vr{background:#ff00ff; color:#fff}
    .btn-clear{background:#444; color:#fff; font-size:11px; padding:5px 10px}

    .channel-list{background:#071018;border-radius:10px;padding:5px;max-height:160px;overflow:auto;border:1px solid #16202a;margin-bottom:10px}
    .channel-item{padding:12px;border-bottom:1px solid #16202a;cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    .channel-item:hover{background:#111b25}
    .channel-item.active{border-left:4px solid var(--accent); background:#111b25}

    #vr-layer { display:none; position:fixed; inset:0; z-index:9999; background:#000 }
    body.is-vr #vr-layer { display:block }
    
    #btn-exit-vr { position:fixed; top:15px; right:15px; z-index:10000; background:var(--danger); color:white; padding:10px 20px; border-radius:20px; font-weight:bold; border:2px solid white; cursor: pointer; }

    #center-guide {
        position: fixed;
        top: 0; bottom: 0; left: 50%;
        width: 2px;
        background: rgba(255, 255, 255, 0.4);
        transform: translateX(-50%);
        z-index: 9998;
        pointer-events: none;
    }

    #feedback{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); color:#fff; padding:15px 25px; border-radius:30px; display:none; z-index:10005; pointer-events:none; border:1px solid var(--accent); white-space:nowrap; font-size: 18px; font-weight: bold; }

    .video-container{background:#000; border-radius:12px; position:relative; overflow:hidden; width:100%; height:320px; border:1px solid #22303a}
    #fullPlayerArea { width:100%; height:100%; position:relative; background:#000; display:flex; align-items:center }
    
    #videoPlayer, #webFrame { width:100%; height:100%; border:none; display:none }
    video { object-fit:contain }

    @media (max-width:640px){ .video-container{height:230px} }
  </style>

  <script type="importmap">{ "imports": { "hls.js": "https://esm.sh/hls.js@1.4.12" } }</script>
</head>
<body>

  <div id="vr-layer">
    <button id="btn-exit-vr" onclick="window.toggleVR(event)">SALIR VR</button>
    <div id="center-guide"></div>

    <a-scene embedded loading-screen="enabled:false" vr-mode-ui="enabled:false">
      <a-entity camera look-controls position="0 1.6 0">
        <a-entity id="vr-display-container" position="0 0 -3.6">
          <a-video id="screenLeft" src="#videoPlayer" width="4.8" height="2.7" material="shader:flat"></a-video>
          <a-video id="screenRight" src="#videoPlayer" width="4.8" height="2.7" material="shader:flat"></a-video>
          <a-plane position="0 0 0.5" width="0.2" height="4" color="#000" material="shader:flat"></a-plane>
        </a-entity>
      </a-entity>
      <a-sky color="#000"></a-sky>
    </a-scene>
  </div>

  <div class="container">
    <h1 style="text-align:center; color:var(--accent); margin:0 0 10px 0; font-size:22px">IPTV VR Player</h1>
    
    <div class="input-section">
      <input id="urlIn" type="text" placeholder="URL (.m3u8, .mp4 o Web)" />
      <button onclick="window.addUrl()" class="btn-load">AÑADIR</button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <button onclick="window.toggleFS()" class="btn-fs">PANTALLA COMPLETA</button>
        <button onclick="window.toggleVR(event)" class="btn-vr">MODO VR</button>
        <button onclick="window.clearAll()" class="btn-clear">Borrar Todo</button>
    </div>

    <div class="channel-list" id="list"></div>

    <div class="video-container">
      <div id="fullPlayerArea">
        <div id="feedback"></div>
        <video id="videoPlayer" crossorigin="anonymous" playsinline webkit-playsinline controls></video>
        <iframe id="webFrame" allow="autoplay; fullscreen; encrypted-media"></iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import Hls from "hls.js";

    const STORAGE_KEY = 'iptv_master_config_v3';
    const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { 
        channels: [], 
        current: -1, 
        eyeGap: 2.15 
    };

    const state = { 
        channels: savedData.channels, 
        current: savedData.current, 
        eyeGap: savedData.eyeGap 
    };
    
    const video = document.getElementById('videoPlayer');
    const iframe = document.getElementById('webFrame');
    const feedback = document.getElementById('feedback');
    let hls = null;

    window.saveState = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };

    function updateEyeGapUI() {
        const left = document.getElementById('screenLeft');
        const right = document.getElementById('screenRight');
        if(left && right) {
            left.setAttribute('position', `-${state.eyeGap} 0 0`);
            right.setAttribute('position', `${state.eyeGap} 0 0`);
            if(document.body.classList.contains('is-vr')){
                showFeedback(`IPD: ${state.eyeGap.toFixed(2)}`);
            }
            window.saveState();
        }
    }

    window.adjustEyes = (delta) => {
        state.eyeGap = Math.max(1.0, Math.min(3.5, state.eyeGap + delta));
        updateEyeGapUI();
    };

    window.playUrl = async (url, index) => {
      state.current = index;
      window.saveState();
      render();
      if(hls){ hls.destroy(); hls = null; }
      const isM3U8 = url.toLowerCase().includes('.m3u8');
      if (isM3U8) {
        iframe.style.display = "none"; video.style.display = "block";
        if (Hls.isSupported()) {
          hls = new Hls(); hls.loadSource(url); hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
        } else { video.src = url; video.play().catch(()=>{}); }
      } else if (url.match(/\.(mp4|webm)$/i)) {
        iframe.style.display = "none"; video.style.display = "block";
        video.src = url; video.play().catch(()=>{});
      } else {
        video.style.display = "none"; video.pause();
        iframe.style.display = "block"; iframe.src = url;
      }
    };

    window.addUrl = () => {
      const input = document.getElementById('urlIn');
      if(input.value.trim()){
        state.channels.push({title: "Canal " + (state.channels.length + 1), url: input.value.trim()});
        input.value = ""; window.saveState(); render();
        window.playUrl(state.channels[state.channels.length-1].url, state.channels.length-1);
      }
    };

    window.playNext = () => {
      if(state.channels.length === 0) return;
      let next = (state.current + 1) % state.channels.length;
      showFeedback("SIGUIENTE ▶");
      window.playUrl(state.channels[next].url, next);
    };

    window.toggleVR = (e) => {
      if(e) e.stopPropagation();
      const isEntering = !document.body.classList.contains('is-vr');
      document.body.classList.toggle('is-vr');
      if (isEntering) {
        document.documentElement.requestFullscreen?.().catch(()=>{});
        updateEyeGapUI();
      } else {
        document.exitFullscreen?.().catch(()=>{});
      }
    };

    window.toggleFS = () => {
      const area = document.getElementById('fullPlayerArea');
      if (!document.fullscreenElement) area.requestFullscreen?.();
      else document.exitFullscreen?.();
    };

    window.clearAll = () => {
      if(confirm("¿Borrar todo?")) {
        state.channels = []; state.current = -1;
        window.saveState(); render();
        video.src = ""; iframe.src = "";
      }
    };

    function showFeedback(txt) {
      feedback.textContent = txt; feedback.style.display = "block";
      setTimeout(() => feedback.style.display = "none", 1200);
    }

    function render() {
      const listDiv = document.getElementById('list');
      if(state.channels.length === 0) {
        listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#444">Lista vacía</div>';
        return;
      }
      listDiv.innerHTML = state.channels.map((ch, i) => 
        `<div class="channel-item ${state.current === i ? 'active' : ''}" onclick="window.playUrl('${ch.url}', ${i})">
            <span>${ch.title}</span><span>PLAY</span>
         </div>`
      ).join('');
    }

    render();
    updateEyeGapUI();
    if(state.current >= 0) window.playUrl(state.channels[state.current].url, state.current);

    // --- CORRECCIÓN DE CLICK DE CONTROL ---
    window.addEventListener('click', (e) => {
        // Solo actuar si estamos en VR y NO hemos pulsado el botón de salir
        if (document.body.classList.contains('is-vr') && e.target.id !== 'btn-exit-vr') {
            e.preventDefault();
            window.playNext();
        }
    }, true); // El 'true' ayuda a capturar el evento antes que otros elementos

    window.addEventListener('touchstart', (e) => {
      if (!document.body.classList.contains('is-vr') || e.target.id === 'btn-exit-vr') return;
      const touchY = e.touches[0].clientY / window.innerHeight;
      if (touchY < 0.25) window.adjustEyes(0.1); 
      else if (touchY > 0.75) window.adjustEyes(-0.1); 
      // El toque central ya no llama a playNext aquí porque el listener de 'click' arriba lo hará por nosotros (los toques también disparan clicks)
    });

    window.addEventListener('keydown', (e) => {
      if (!document.body.classList.contains('is-vr')) return;
      const k = e.code;
      if (k === 'ArrowUp' || k === 'KeyW') { e.preventDefault(); window.adjustEyes(0.05); }
      if (k === 'ArrowDown' || k === 'KeyS') { e.preventDefault(); window.adjustEyes(-0.05); }
      if (k === 'Enter' || k === 'Space') { e.preventDefault(); window.playNext(); }
    });
  </script>
</body>
</html>